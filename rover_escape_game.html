<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rover Escape: Mars Mayhem</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    canvas { background: #111; display: block; margin: 30px auto; border: 3px solid #eee; }
    body { color: white; font-family: monospace; background: #000; text-align: center; }
    #info { margin-top: 5px; }
    #gameover { position: absolute; top:50%; left:50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.85); padding: 30px; border: 2px solid white; font-size: 24px; display: none; }
  </style>
</head>
<body>
  <h1>ðŸš€ Rover Escape: Mars Mayhem</h1>
  <p>Collect tools, bring them to the base station, and dodge dust devils!</p>
  <canvas id="gameCanvas" width="500" height="500"></canvas>
  <div id="info">
    <span id="status"></span> | <span id="score">Score: 0</span> | <span id="inventory">Tools Held: 0</span> | <span id="health">Health: 5</span>
  </div>
  <div id="gameover">Game Over! <br> Score: <span id="finalScore">0</span><br>Refresh to play again.</div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const gridSize = 25;
    const cols = Math.floor(canvas.width / gridSize);
    const rows = Math.floor(canvas.height / gridSize);

    let rover = { x: 2, y: 2 };
    let tools = [];
    let hazards = [];
    let toolHeld = 0;
    let score = 0;
    let health = 5;
    let gameOver = false;
    let lastHitTime = 0;
    const hitCooldown = 500; // ms

    // Base station at fixed location
    const base = { x: cols - 3, y: rows - 3, size: 2 };

    function randomDir() {
      let angle = Math.random() * Math.PI * 2;
      return { dx: Math.cos(angle)/10, dy: Math.sin(angle)/10 };
    }

    function spawnTool() {
      tools.push({ x: Math.floor(Math.random() * cols), y: Math.floor(Math.random() * rows) });
    }

    function spawnHazard() {
      const pos = { x: Math.floor(Math.random() * cols), y: Math.floor(Math.random() * rows) };
      const dir = randomDir();
      hazards.push({ x: pos.x, y: pos.y, vel: dir, speed: 0.2 + Math.random() * 0.3 });
    }

    // initial
    for (let i = 0; i < 3; i++) spawnTool();
    for (let i = 0; i < 3; i++) spawnHazard();

    document.addEventListener("keydown", (e) => {
      if (gameOver) return;
      if (e.key === "ArrowUp") rover.y--;
      else if (e.key === "ArrowDown") rover.y++;
      else if (e.key === "ArrowLeft") rover.x--;
      else if (e.key === "ArrowRight") rover.x++;

      if (rover.x < 0) rover.x = 0;
      if (rover.x >= cols) rover.x = cols - 1;
      if (rover.y < 0) rover.y = 0;
      if (rover.y >= rows) rover.y = rows - 1;
    });

    function update() {
      if (gameOver) return;

      // Move hazards randomly
      hazards.forEach(h => {
        h.x += h.vel.dx * h.speed;
        h.y += h.vel.dy * h.speed;
        if (h.x < 0) h.x = cols - 1;
        if (h.x >= cols) h.x = 0;
        if (h.y < 0) h.y = rows - 1;
        if (h.y >= rows) h.y = 0;
      });

      // Collect tool
      for (let i = tools.length - 1; i >= 0; i--) {
        if (tools[i].x === rover.x && tools[i].y === rover.y) {
          toolHeld++;
          tools.splice(i, 1);
          document.getElementById("status").innerText = "ðŸ”§ Picked up a tool!";
          updateUI();
        }
      }

      // Deposit at base
      if (rover.x === base.x && rover.y === base.y && toolHeld > 0) {
        score += toolHeld * 10;
        document.getElementById("status").innerText = `ðŸ“¦ Delivered ${toolHeld} tool(s)! +${toolHeld * 10} pts`;
        toolHeld = 0;
        updateUI();
      }

      // Collision with hazard, with cooldown and health
      const now = performance.now();
      hazards.forEach(h => {
        const hx = Math.floor(h.x);
        const hy = Math.floor(h.y);
        if (hx === rover.x && hy === rover.y) {
          if (now - lastHitTime > hitCooldown) {
            lastHitTime = now;
            health -= 1;
            score = Math.max(0, score - 5);
            document.getElementById("status").innerText = "ðŸ’¥ Hit by dust devil! -1 health, -5 pts.";
            updateUI();
            if (health <= 0) {
              gameOver = true;
              document.getElementById('finalScore').innerText = score;
              document.getElementById('gameover').style.display = 'block';
            }
          }
        }
      });
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // grid
      ctx.strokeStyle = '#222';
      for (let i = 0; i <= cols; i++) { ctx.beginPath(); ctx.moveTo(i * gridSize, 0); ctx.lineTo(i * gridSize, canvas.height); ctx.stroke(); }
      for (let i = 0; i <= rows; i++) { ctx.beginPath(); ctx.moveTo(0, i * gridSize); ctx.lineTo(canvas.width, i * gridSize); ctx.stroke(); }

      // base station
      ctx.fillStyle = 'cyan';
      ctx.fillRect(base.x * gridSize, base.y * gridSize, base.size * gridSize, base.size * gridSize);
      ctx.fillStyle = 'white';
      ctx.fillText('BASE', base.x * gridSize + 2, base.y * gridSize + 12);

      // tools
      ctx.fillStyle = 'yellow';
      tools.forEach(t => { ctx.fillRect(t.x * gridSize + 2, t.y * gridSize + 2, gridSize - 4, gridSize - 4); });

      // hazards
      ctx.fillStyle = 'red';
      hazards.forEach(h => { ctx.fillRect(Math.floor(h.x) * gridSize + 4, Math.floor(h.y) * gridSize + 4, gridSize - 8, gridSize - 8); });

      // rover
      ctx.fillStyle = 'lime';
      ctx.fillRect(rover.x * gridSize + 2, rover.y * gridSize + 2, gridSize - 4, gridSize - 4);
    }

    function updateUI() {
      document.getElementById('score').innerText = `Score: ${score}`;
      document.getElementById('inventory').innerText = `Tools Held: ${toolHeld}`;
      document.getElementById('health').innerText = `Health: ${health}`;
    }

    // spawn periodically
    setInterval(() => { if (!gameOver && tools.length < 4) spawnTool(); }, 2000);
    setInterval(() => { if (!gameOver && hazards.length < 5) spawnHazard(); }, 4000);

    // loop
    function loop() { update(); draw(); if (!gameOver) requestAnimationFrame(loop); }
    loop();
  </script>
</body>
</html>